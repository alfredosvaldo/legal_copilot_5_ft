<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Copiloto Legal — Comparador Multiartículo (FT + OpenAI)</title>

<!-- UI -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Utilidades -->
<script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>

<style>
  body { font-family: 'Inter', sans-serif; }
  ins { background:#d4edda; text-decoration:none; }
  del { background:#f8d7da; text-decoration:line-through; }
  .loader{border:4px solid #f3f3f3;border-top:4px solid #2563eb;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:2rem auto;}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  #resultsTable th,#resultsTable td{border:1px solid #e5e7eb;padding:10px;vertical-align:top}
  #resultsTable th{background:#f8fafc;text-align:left}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace}
</style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

<div class="container mx-auto p-4 md:p-8 flex-1">
  <header class="mb-6">
    <h1 class="text-3xl md:text-4xl font-bold">Copiloto Legal — Multiartículo</h1>
    <p class="text-gray-600">Segmenta localmente ▸ empareja A/B/C/D ▸ pide SOLO “Indicaciones” por artículo (JSON) ▸ numera global ▸ diff ▸ Word.</p>
  </header>

  <!-- Config -->
  <section class="bg-white p-5 rounded-lg shadow mb-6 grid gap-4 md:grid-cols-3">
    <div class="md:col-span-2">
      <label class="block font-semibold mb-2">OpenAI API Key</label>
      <input type="password" id="apiKey" class="w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Pega tu API key"/>
      <p class="text-sm text-gray-500 mt-1">Se usa solo en tu navegador.</p>
    </div>
    <div>
      <label class="block font-semibold mb-2">Modelo</label>
      <input type="text" id="modelName" class="w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 mono" placeholder="ft:..." />
      <p class="text-xs text-gray-500 mt-1">Predefinido: tu modelo FT. Puedes cambiarlo.</p>
    </div>
    <div class="md:col-span-3 flex items-center gap-3">
      <input id="remember" type="checkbox" class="h-4 w-4" checked/>
      <label for="remember" class="text-sm text-gray-700">Recordar API key y modelo en este navegador</label>
    </div>
  </section>

  <!-- Inputs -->
  <section class="grid gap-6 md:grid-cols-2">
    <div class="bg-white p-5 rounded-lg shadow">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">Texto Original (completo)</h2>
        <button id="pasteOriginal" class="text-sm text-blue-600 hover:underline">Pegar</button>
      </div>
      <textarea id="originalText" class="w-full h-96 p-3 border rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Pega aquí el texto original completo…"></textarea>
    </div>
    <div class="bg-white p-5 rounded-lg shadow">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">Texto Final (completo)</h2>
        <button id="pasteFinal" class="text-sm text-blue-600 hover:underline">Pegar</button>
      </div>
      <textarea id="finalText" class="w-full h-96 p-3 border rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Pega aquí el texto final completo…"></textarea>
    </div>
  </section>

  <!-- Acciones -->
  <div class="flex flex-wrap gap-3 justify-center my-8">
    <button id="generateButton" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-green-700 focus:ring-4 focus:ring-green-300 disabled:bg-gray-400">Generar tabla comparativa</button>
    <button id="exportButton" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-blue-700">Exportar a Word</button>
    <button id="clearButton" class="bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow hover:bg-gray-300">Limpiar</button>
  </div>

  <!-- Resultados -->
  <section id="outputSection" class="bg-white p-5 rounded-lg shadow hidden">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-xl font-semibold">Resultado <span id="timerResult" class="text-sm font-normal text-gray-500 ml-2"></span></h3>
      <span id="modelUsed" class="text-xs text-gray-500 mono"></span>
    </div>
    <div id="resultsContainer" class="w-full overflow-x-auto"></div>
    <details class="mt-4">
      <summary class="cursor-pointer text-sm text-gray-600">Registro de análisis (debug)</summary>
      <pre id="debugLog" class="text-xs bg-gray-50 border rounded p-3 overflow-auto max-h-64 whitespace-pre-wrap"></pre>
    </details>
  </section>

  <!-- Errores -->
  <div id="errorBox" class="hidden mt-4 p-4 rounded bg-red-50 border border-red-200 text-red-700"></div>
</div>

<footer class="text-center p-4 text-gray-500 text-sm">
  Copiloto Legal — Multiartículo • Cliente 100% local
</footer>

<script>
/* ===== Config ===== */
const $ = (id)=>document.getElementById(id);
const defaultFTModel   = "ft:gpt-4.1-mini-2025-04-14:personal:copiloto-legal-fine:C7rwpGL7";
const baseFallbackModel= "gpt-4.1-mini-2025-04-14";

(function boot(){
  const k = localStorage.getItem("openai_key");
  const m = localStorage.getItem("openai_model");
  if (k) $("apiKey").value = k;
  $("modelName").value = m || defaultFTModel;
})();
$("remember").addEventListener("change",(e)=>{ if(!e.target.checked){ localStorage.removeItem("openai_key"); localStorage.removeItem("openai_model"); }});
$("pasteOriginal").onclick = async()=>{ try{$("originalText").value = await navigator.clipboard.readText();}catch{} };
$("pasteFinal").onclick    = async()=>{ try{$("finalText").value    = await navigator.clipboard.readText();}catch{} };
$("clearButton").onclick   = ()=>{ $("resultsContainer").innerHTML=""; $("outputSection").classList.add("hidden"); $("timerResult").textContent=""; $("debugLog").textContent=""; hideError(); };

/* ===== UI helpers ===== */
function showError(msg){ const box=$("errorBox"); box.textContent=msg; box.classList.remove("hidden"); }
function hideError(){ $("errorBox").classList.add("hidden"); }
function escapeHtml(s){ return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function sanitize(s){ return escapeHtml(s).replace(/\n/g,"<br>"); }
function dlog(...args){ $("debugLog").textContent += args.join(" ") + "\n"; }

/* ===== Robust segmenter (encabezado en la misma línea también) ===== */
function splitArticles(text){
  const src = (text||"").replace(/\r\n/g,"\n");
  // Detecta “Artículo N°”, romanos o ordinales; opcional “transitorio”; header puede terminar con .-, . o :
  const re = /(^|\n)(Artículo\s+(?:\d+[°º]?|[ivxlcdm]+|[A-Za-zÁÉÍÓÚÑáéíóúñ]+)(?:\s+transitorio)?)(?:\s*(?:\.-|\.|:))?/gmi;
  const blocks = [];
  let m, positions=[];
  while ((m = re.exec(src)) !== null) {
    positions.push({start:m.index + (m[1] ? m[1].length : 0), header:m[2], end:re.lastIndex});
  }
  for(let i=0;i<positions.length;i++){
    const cur = positions[i], next = positions[i+1];
    const headerFull = normalizeHeader(cur.header);
    const body = src.slice(cur.end, next ? next.start : src.length).trim();
    blocks.push({ header: headerFull, body });
  }
  // construir keys normalizadas
  const ord = {'primero':'1','segundo':'2','tercero':'3','cuarto':'4','quinto':'5','sexto':'6','séptimo':'7','septimo':'7','octavo':'8','noveno':'9','décimo':'10','decimo':'10'};
  blocks.forEach(b=>{
    let key = b.header.toLowerCase();
    key = key.replace(/artículo\s+(\d+)[°º]?/i,(_,n)=>`artículo ${n}`);
    key = key.replace(/artículo\s+([ivxlcdm]+)/i,(_,r)=>`artículo ${romanToInt(r)||r}`);
    key = key.replace(/artículo\s+([a-záéíóúñ]+)/i,(_,w)=>`artículo ${ord[w]||w}`);
    if(/transitorio/i.test(b.header)) key += " transitorio";
    b.key = key.trim();
    b.text= b.body;
  });
  return blocks;
}
function normalizeHeader(h){ return (h||"").replace(/\s+/g," ").trim().replace(/^Artículo\s+/i,"Artículo "); }
function romanToInt(str){
  const s=(str||"").toUpperCase().replace(/[^IVXLCDM]/g,''); if(!s) return null;
  const map={I:1,V:5,X:10,L:50,C:100,D:500,M:1000}; let v=0,p=0;
  for(let i=s.length-1;i>=0;i--){ const n=map[s[i]]; v += n<p ? -n : n; p=n; }
  return v||null;
}

/* ===== Pairing A/B/C/D ===== */
function tokenizeSafe(t){ return (t||"").toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").match(/[a-z0-9]+/g) || []; }
function jaccard(a,b){ const A=new Set(tokenizeSafe(a)), B=new Set(tokenizeSafe(b)); let inter=0; A.forEach(x=>{if(B.has(x)) inter++;}); const uni=new Set([...A,...B]).size||1; return inter/uni; }

function pairArticles(origBlocks, finBlocks){
  const oMap=new Map(origBlocks.map(b=>[b.key,b]));
  const fMap=new Map(finBlocks.map(b=>[b.key,b]));
  const usedF=new Set(); const pairs=[];

  // A: misma clave
  for(const [k,o] of oMap){ if(fMap.has(k)){ const f=fMap.get(k); usedF.add(k); pairs.push({type:'A', original:o, final:f}); } }
  // B: nuevos
  for(const [k,f] of fMap){ if(!oMap.has(k)&&!usedF.has(k)){ usedF.add(k); pairs.push({type:'B', original:null, final:f}); } }
  // C/D: originales sin par
  for(const [k,o] of oMap){
    if(pairs.find(p=>p.original?.key===k)) continue;
    let bestKey=null, bestS=0;
    for(const [kf,f] of fMap){ if(usedF.has(kf)) continue; const s=jaccard(o.text, f.text); if(s>bestS){ bestS=s; bestKey=kf; } }
    if(bestS>=0.90){ const f=fMap.get(bestKey); usedF.add(bestKey); pairs.push({type:'D', original:o, final:f}); }
    else { pairs.push({type:'C', original:o, final:null}); }
  }

  // Orden por aparición en el Final; lo sin final al final
  const order = new Map(finBlocks.map((b,i)=>[b.key,i]));
  pairs.sort((a,b)=>{
    const ia = a.final ? order.get(a.final.key) ?? 1e9 : 1e9;
    const ib = b.final ? order.get(b.final.key) ?? 1e9 : 1e9;
    return ia-ib;
  });
  return pairs;
}

/* ===== Prompt por artículo (JSON estricto) ===== */
function buildArticlePromptJSON(pair){
  const head = (pair.final?.header) || (pair.original?.header) || "Artículo";
  const O = pair.original ? `\n[ORIGINAL]\n${pair.original.header}\n${pair.original.text}` : "";
  const F = pair.final    ? `\n[FINAL]\n${pair.final.header}\n${pair.final.text}`       : "";
  const caso = pair.type; // A|B|C|D

  const system = [
    "Eres asesor legislativo chileno.",
    "Devuelve ÚNICAMENTE un JSON válido UTF-8 sin texto adicional, con este esquema:",
    '{"al_articulo":"AL ARTÍCULO [nombre completo]","indicaciones":["1) ...","   a) ...","2) ..."]}',
    "Reglas: redacta en español normativo; usa verbos Incorpórase, Sustitúyese, Intercálese, Suprímese, Modifícase; mínimo 1 indicación; máximo 12 líneas en total.",
    "Si el caso es B (nuevo), C (eliminado) o D (renumerado), indícalo explícitamente en la primera indicación."
  ].join("\n");

  const user = [
    `Genera INDICACIONES (JSON) para ${head}. Caso ${caso}.`,
    "No repitas párrafos completos; sé concreto.",
    O, F
  ].join("\n");

  return { system, user, header: head };
}

/* ===== Llamadas a la API, concurrencia 2, JSON parse ===== */
async function callIndicationsForAll(pairs, model, apiKey){
  const results=[]; const limit=2; let cursor=0, running=0;

  return new Promise((resolve)=>{
    const tick=()=>{
      if(cursor>=pairs.length && running===0) return resolve(results);
      while(running<limit && cursor<pairs.length){
        const idx=cursor++; running++;
        (async()=>{
          const p = pairs[idx];
          const {system, user, header} = buildArticlePromptJSON(p);
          try{
            const obj = await askJSON(system, user, model, apiKey);
            const al  = (obj.al_articulo || `AL ARTÍCULO ${header.replace(/^Artículo\s+/i,'')}`).trim();
            const arr = Array.isArray(obj.indicaciones) ? obj.indicaciones.map(s=>String(s||"").trim()).filter(Boolean) : [];
            if (!arr.length) throw new Error("JSON sin 'indicaciones'");
            const block = [al, ...arr].join("\n");
            results[idx] = { ok:true, pair:p, header, indicaciones: block };
          }catch(e){
            results[idx] = { ok:false, pair:p, header, error: String(e) };
          }finally{ running--; tick(); }
        })();
      }
    };
    tick();
  });
}

async function askJSON(systemContent, userContent, model, apiKey){
  const url="https://api.openai.com/v1/chat/completions";
  const payload={
    model,
    response_format: { type: "json_object" },
    messages: [
      {role:"system", content:systemContent},
      {role:"user",   content:userContent}
    ],
    temperature:0.0,
    max_tokens:1200
  };
  let lastErr;
  for(let i=0;i<5;i++){
    try{
      const res=await fetch(url,{
        method:"POST",
        headers:{ "Content-Type":"application/json","Authorization":`Bearer ${apiKey}` },
        body:JSON.stringify(payload)
      });
      if(res.ok){
        const data=await res.json();
        const text=data?.choices?.[0]?.message?.content||"";
        if(!text) throw new Error("Respuesta vacía.");
        try{ return JSON.parse(text); }catch(e){ throw new Error("No es JSON válido."); }
      }
      if((res.status===429 || res.status>=500) && i<4){
        await new Promise(r=>setTimeout(r, (2**i)*1000 + Math.random()*500));
        continue;
      }
      throw new Error(`HTTP ${res.status}: ${await res.text()}`);
    }catch(e){ lastErr=e; await new Promise(r=>setTimeout(r,(2**i)*1000)); }
  }
  throw lastErr;
}

/* ===== Deduplicación & numeración global ===== */
function dedupeLines(text){
  // evita repeticiones accidentales tipo "AL ARTÍCULO X°" en cascada
  const seen=new Set(); const out=[];
  for(const ln of text.split(/\r?\n/)){
    const key = ln.trim();
    if(key && seen.has(key)) continue;
    seen.add(key); out.push(ln);
  }
  return out.join("\n");
}
function renumberGlobally(blocks){
  let n=1; const out=[];
  for(const b of blocks){
    const lines=b.split(/\r?\n/); const acc=[];
    for(const ln of lines){
      if(/^\s*\d+\)\s/.test(ln)){ acc.push(ln.replace(/^\s*\d+\)/, `${n++})`)); }
      else acc.push(ln);
    }
    out.push(dedupeLines(acc.join("\n")));
  }
  return out;
}

/* ===== Render con diff y export ===== */
function renderTable(articles){
  const container=$("resultsContainer"); container.innerHTML="";
  if(!articles.length){ container.innerHTML=`<p class="text-red-500">No hay artículos para mostrar.</p>`; return; }

  const table=document.createElement("table");
  table.id="resultsTable"; table.className="w-full border-collapse text-sm md:text-base";
  table.innerHTML=`
    <thead>
      <tr>
        <th class="w-1/3">Texto Original (con diffs)</th>
        <th class="w-1/3">Indicaciones</th>
        <th class="w-1/3">Texto Final (con diffs)</th>
      </tr>
    </thead>
    <tbody></tbody>`;
  const tbody=table.querySelector("tbody");

  articles.forEach(a=>{
    const diff=Diff.diffWords(a.original||"", a.final||"", {ignoreWhitespace:true});
    let oHtml="", fHtml="";
    diff.forEach(part=>{
      const s=escapeHtml(part.value);
      if(part.added) fHtml+=`<ins>${s}</ins>`;
      else if(part.removed) oHtml+=`<del>${s}</del>`;
      else { oHtml+=s; fHtml+=s; }
    });
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="align-top whitespace-pre-wrap">${oHtml}</td>
      <td class="align-top whitespace-pre-wrap">${sanitize(a.indicaciones)}</td>
      <td class="align-top whitespace-pre-wrap">${fHtml}</td>`;
    tbody.appendChild(tr);
  });

  container.appendChild(table);
  $("outputSection").classList.remove("hidden");
}
$("exportButton").onclick = ()=>{
  const table=$("resultsTable"); if(!table) return showError("No hay resultados para exportar.");
  const content = `
  <!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>
    body{font-family:'Times New Roman',Times,serif;}
    table{border-collapse:collapse;width:100%;}
    th,td{border:1px solid #000;padding:8px;vertical-align:top;white-space:pre-wrap;}
    th{background:#f2f2f2;}
    ins{background:#d4edda;text-decoration:none;color:#000;}
    del{background:#f8d7da;text-decoration:line-through;color:#000;}
  </style></head><body>
    <h1>Tabla Comparativa de Indicaciones</h1>${table.outerHTML}
  </body></html>`;
  const blob = htmlDocx.asBlob(content);
  saveAs(blob, "Tabla_Comparativa_Indicaciones.docx");
};

/* ===== Orquestación ===== */
$("generateButton").onclick = generate;

async function generate(){
  hideError(); $("debugLog").textContent="";
  const key = $("apiKey").value.trim();
  const model = ($("modelName").value.trim()) || baseFallbackModel;
  const original = $("originalText").value.trim();
  const finalTxt = $("finalText").value.trim();
  if(!key) return showError("Ingresa tu OpenAI API key.");
  if(!original || !finalTxt) return showError("Pega texto en ambas columnas.");

  if($("remember").checked){ localStorage.setItem("openai_key",key); localStorage.setItem("openai_model",model); }

  $("generateButton").disabled = true;
  $("resultsContainer").innerHTML = '<div class="loader"></div>';
  $("outputSection").classList.remove("hidden");
  $("timerResult").textContent=""; $("modelUsed").textContent="";
  const t0 = performance.now();

  try{
    // 1) Parseo & emparejado
    const OB = splitArticles(original);
    const FB = splitArticles(finalTxt);
    dlog("Detectados — Original:", OB.length, "Final:", FB.length);
    if(!OB.length || !FB.length) throw new Error("No se detectaron encabezados 'Artículo …' en uno de los textos.");

    const pairs = pairArticles(OB, FB);
    dlog("Pares/Clases:", pairs.map(p=>p.type).join(", "));

    // 2) JSON por artículo (FT) y fallback por artículo si falla
    let perArticle = await callIndicationsForAll(pairs, model, key);
    const failedIdx = perArticle.map((r,i)=>!r?.ok?i:-1).filter(i=>i>=0);
    if(failedIdx.length){
      dlog("Reintentos con modelo base en índices:", failedIdx.join(", "));
      const retryPairs = failedIdx.map(i=>pairs[i]);
      const retried = await callIndicationsForAll(retryPairs, baseFallbackModel, key);
      failedIdx.forEach((pos,j)=> perArticle[pos] = retried[j]);
    }

    // 3) Construcción + numeración global
    const rows = perArticle.map(r=>{
      const originalBlock = r.pair.original ? `${r.pair.original.header}\n${r.pair.original.text}` : "";
      const finalBlock    = r.pair.final    ? `${r.pair.final.header}\n${r.pair.final.text}`       : "";
      const indic = r.ok ? r.indicaciones :
`AL ARTÍCULO ${(r.header||'')}
1) Para consignar la imposibilidad de generar indicaciones.
   a) Déjase constancia: ${r.error||'Error desconocido.'}`;
      return { original: originalBlock, final: finalBlock, indicaciones: indic };
    });

    const global = renumberGlobally(rows.map(r=>r.indicaciones));
    rows.forEach((r,i)=> r.indicaciones = global[i]);

    // 4) Render
    renderTable(rows);

    const t1 = performance.now();
    $("timerResult").textContent = `(generado en ${((t1-t0)/1000).toFixed(1)}s; artículos: ${rows.length})`;
    $("modelUsed").textContent = `Modelo: ${model}`;
  }catch(err){
    showError(err.message || String(err));
  }finally{
    $("generateButton").disabled = false;
  }
}

/* ===== Captura de errores globales (debug) ===== */
window.addEventListener("error",(e)=>{ showError("JS error: " + (e.message || e.error || "desconocido")); });
window.addEventListener("unhandledrejection",(e)=>{ showError("Promesa rechazada: " + (e.reason?.message || String(e.reason))); });
</script>
</body>
</html>
